<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.68.3" /><meta name="theme-color" content="#fff" />
        <script>
            const userPrefers = localStorage.getItem('theme');
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            const lightModeMediaQuery = window.matchMedia('(prefers-color-scheme: light)');
            if (userPrefers === 'dark') {
                changeModeMeta('dark');
            } else if (userPrefers === 'light') {
                changeModeMeta('light');
            } else if (darkModeMediaQuery.matches) {
                changeModeMeta('dark');
            } else if (lightModeMediaQuery.matches) {
                changeModeMeta('light');
            }
            function changeModeMeta(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'dark') {
                    changeThemeColor('#282a36');
                } else {
                    changeThemeColor('#fff');
                }
            }
            function changeThemeColor(themeColor) {
                document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColor);
            }
        </script>

    

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Spring Security JWT | WSS.COOL</title>

    <link rel="stylesheet" href="/css/meme.min.e294d07443249083a294a7723a3568701987e1b7b0db5df0152acef18067dfbf.css" integrity="sha256-4pTQdEMkkIOilKdyOjVocBmH4bew213wFSrO8YBn378=" />

    

    <meta name="author" content="ç‹ä¹¦ç¡•" />
    
    
    <meta name="description" content="Spring Security Architecture Spring Security æ¶æ„ï¼Œå…¥é—¨ä»‹ç»ï¼šç½‘å€ Authentication and Access Control åº”ç”¨ç¨‹åºå®‰å…¨æ€§å½’ç»“ä¸ºæˆ–å¤šæˆ–å°‘çš„ä¸¤ä¸ªç‹¬ç«‹é—®é¢˜ï¼šèº«â€¦â€¦" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="WSS.COOL" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="WSS.COOL" />
    <meta name="msapplication-starturl" content="../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="https://wss.cool/spring-security-jwt.html" />



<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2020-01-19T13:51:29+08:00",
        "dateModified": "2021-11-12T18:13:27+00:00",
        "url": "https://wss.cool/spring-security-jwt.html",
        "headline": "Spring Security JWT",
        "description": "Spring Security Architecture Spring Security æ¶æ„ï¼Œå…¥é—¨ä»‹ç»ï¼šç½‘å€ Authentication and Access Control åº”ç”¨ç¨‹åºå®‰å…¨æ€§å½’ç»“ä¸ºæˆ–å¤šæˆ–å°‘çš„ä¸¤ä¸ªç‹¬ç«‹é—®é¢˜ï¼šèº«â€¦â€¦",
        "inLanguage" : "zh-CN",
        "articleSection": "posts",
        "wordCount":  6572 ,
        "image": ["https://wss.cool/images/1.png","https://wss.cool/images/2.png","https://wss.cool/images/3.png","https://wss.cool/images/4.png","https://wss.cool/images/5.png"],
        "author": {
            "@type": "Person",
            "description": "Code Complete is Good",
            "email": "wss.six@foxmail.com",
            "image": "https://wss.cool/icons/apple-touch-icon.png",
            "url": "https://wss.cool/",
            "name": "ç‹ä¹¦ç¡•"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)",
        "publisher": {
            "@type": "Organization",
            "name": "WSS.COOL",
            "logo": {
                "@type": "ImageObject",
                "url": "https://wss.cool/icons/apple-touch-icon.png"
            },
            "url": "https://wss.cool/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://wss.cool/"
        }
    }
</script>

    



<meta name="twitter:card" content="summary_large_image" />


<meta name="twitter:site" content="@shuo666" />
<meta name="twitter:creator" content="@shuo666" />

    





<meta property="og:title" content="Spring Security JWT" />
<meta property="og:description" content="Spring Security Architecture Spring Security æ¶æ„ï¼Œå…¥é—¨ä»‹ç»ï¼šç½‘å€ Authentication and Access Control åº”ç”¨ç¨‹åºå®‰å…¨æ€§å½’ç»“ä¸ºæˆ–å¤šæˆ–å°‘çš„ä¸¤ä¸ªç‹¬ç«‹é—®é¢˜ï¼šèº«â€¦â€¦" />
<meta property="og:url" content="https://wss.cool/spring-security-jwt.html" />
<meta property="og:site_name" content="WSS.COOL" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="https://wss.cool/images/1.png" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2020-01-19T13:51:29+08:00" />
    <meta property="article:modified_time" content="2021-11-12T18:13:27+00:00" />
    
    <meta property="article:section" content="posts" />



    
</head>

    <body>
        <div class="container">
            
    <header class="header" data-scroll-header>
        
            <div class="header-wrapper">
                <div class="header-inner">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">WSS.COOL</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/posts/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon "><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">æ–‡ç« </span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon "><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm386.667-56H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24z"/></svg><span class="menu-item-name">åˆ†ç±»</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon "><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">å…³äº</span></a>
                </li>
            
        
            
                
                    <li class="menu-item">
                        
    
        
            
        
        <div id="theme-switcher">ğŸŒ</div>
    


                    </li>
                
            
        
            
                
            
        
    </ul>
</nav>

                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        <article class="content post" data-align="justify" data-type="posts" data-toc-num="true">

            <h1 class="post-title">Spring Security JWT</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2020-01-19T13:51:29+08:00" class="post-meta-item published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;2020.1.19</time>
    
    
        
        <time datetime="2021-11-12T18:13:27+00:00" class="post-meta-item modified"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M400 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V160h352v298a6 6 0 0 1-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2021.11.12</time>
    
    
    
        
        
        
            
                
                <span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href="/categories/%E5%90%8E%E7%AB%AF/" class="category-link">åç«¯</a></span>
            
        
    
    
        
        <span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;6572</span>
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;14&nbsp;åˆ†é’Ÿ</span>
    
    
</div>
            

            
                <nav class="contents">
  <h2 id="contents" class="contents-title">ç›®å½•</h2><ol class="toc">
    <li><a id="contents:authentication-and-access-control" href="#authentication-and-access-control">Authentication and Access Control</a>
      <ol>
        <li><a id="contents:authentication" href="#authentication">Authentication</a></li>
      </ol>
    </li>
  </ol>

  <ol>
    <li><a id="contents:1dependencies" href="#1dependencies">1Â Dependencies</a></li>
    <li><a id="contents:2minimal-configuration-for-jwts" href="#2minimal-configuration-for-jwts">2Â Minimal Configuration for JWTs</a>
      <ol>
        <li><a id="contents:specifying-the-authorization-server" href="#specifying-the-authorization-server">Specifying the Authorization Server</a></li>
        <li><a id="contents:startup-expectations" href="#startup-expectations">Startup Expectations</a></li>
        <li><a id="contents:runtime-expectations" href="#runtime-expectations">Runtime Expectations</a></li>
      </ol>
    </li>
    <li><a id="contents:3specifying-the-authorization-server-jwk-set-uri-directly" href="#3specifying-the-authorization-server-jwk-set-uri-directly">3Â Specifying the Authorization Server JWK Set Uri Directly</a></li>
    <li><a id="contents:4overriding-or-replacing-boot-auto-configuration" href="#4overriding-or-replacing-boot-auto-configuration">4Â Overriding or Replacing Boot Auto Configuration</a>
      <ol>
        <li><a id="contents:using-jwkseturi" href="#using-jwkseturi">Using <code>jwkSetUri()</code></a></li>
        <li><a id="contents:using-decoder" href="#using-decoder">Using <code>decoder()</code></a></li>
        <li><a id="contents:exposing-a-jwtdecoder-bean" href="#exposing-a-jwtdecoder-bean">Exposing a <code>JwtDecoder</code> <code>@Bean</code></a></li>
      </ol>
    </li>
    <li><a id="contents:5configuring-trusted-algorithms" href="#5configuring-trusted-algorithms">5Â Configuring Trusted Algorithms</a>
      <ol>
        <li><a id="contents:via-spring-boot" href="#via-spring-boot">Via Spring Boot</a></li>
        <li><a id="contents:using-a-builder" href="#using-a-builder">Using a Builder</a></li>
        <li><a id="contents:from-jwk-set-response" href="#from-jwk-set-response">From JWK Set response</a></li>
      </ol>
    </li>
    <li><a id="contents:6trusting-a-single-asymmetric-key" href="#6trusting-a-single-asymmetric-key">6Â Trusting a Single Asymmetric Key</a>
      <ol>
        <li><a id="contents:via-spring-boot-1" href="#via-spring-boot-1">Via Spring Boot</a></li>
        <li><a id="contents:using-a-builder-1" href="#using-a-builder-1">Using a Builder</a></li>
      </ol>
    </li>
    <li><a id="contents:7trusting-a-single-symmetric-key" href="#7trusting-a-single-symmetric-key">7Â Trusting a Single Symmetric Key</a></li>
    <li><a id="contents:8configuring-authorization" href="#8configuring-authorization">8Â Configuring Authorization</a>
      <ol>
        <li><a id="contents:extracting-authorities-manually" href="#extracting-authorities-manually">Extracting Authorities Manually</a></li>
      </ol>
    </li>
    <li><a id="contents:9configuring-validation" href="#9configuring-validation">9Â Configuring Validation</a>
      <ol>
        <li><a id="contents:customizing-timestamp-validation" href="#customizing-timestamp-validation">Customizing Timestamp Validation</a></li>
        <li><a id="contents:configuring-a-custom-validator" href="#configuring-a-custom-validator">Configuring a Custom Validator</a></li>
      </ol>
    </li>
    <li><a id="contents:10configuring-claim-set-mapping" href="#10configuring-claim-set-mapping">10Â Configuring Claim Set Mapping</a>
      <ol>
        <li><a id="contents:customizing-the-conversion-of-a-single-claim" href="#customizing-the-conversion-of-a-single-claim">Customizing the Conversion of a Single Claim</a></li>
        <li><a id="contents:adding-a-claim" href="#adding-a-claim">Adding a Claim</a></li>
        <li><a id="contents:removing-a-claim" href="#removing-a-claim">Removing a Claim</a></li>
        <li><a id="contents:renaming-a-claim" href="#renaming-a-claim">Renaming a Claim</a></li>
      </ol>
    </li>
    <li><a id="contents:11configuring-timeouts" href="#11configuring-timeouts">11Â Configuring Timeouts</a></li>
    <li><a id="contents:12minimal-configuration-for-introspection" href="#12minimal-configuration-for-introspection">12Â Minimal Configuration for Introspection</a>
      <ol>
        <li><a id="contents:specifying-the-authorization-server-1" href="#specifying-the-authorization-server-1">Specifying the Authorization Server</a></li>
        <li><a id="contents:startup-expectations-1" href="#startup-expectations-1">Startup Expectations</a></li>
        <li><a id="contents:runtime-expectations-1" href="#runtime-expectations-1">Runtime Expectations</a></li>
      </ol>
    </li>
    <li><a id="contents:13looking-up-attributes-post-authentication" href="#13looking-up-attributes-post-authentication">13Â Looking Up Attributes Post-Authentication</a>
      <ol>
        <li><a id="contents:looking-up-attributes-via-spel" href="#looking-up-attributes-via-spel">Looking Up Attributes Via SpEL</a></li>
      </ol>
    </li>
    <li><a id="contents:14overriding-or-replacing-boot-auto-configuration" href="#14overriding-or-replacing-boot-auto-configuration">14Â Overriding or Replacing Boot Auto Configuration</a>
      <ol>
        <li><a id="contents:using-introspectionuri" href="#using-introspectionuri">Using <code>introspectionUri()</code></a></li>
        <li><a id="contents:using-introspector" href="#using-introspector">Using <code>introspector()</code></a></li>
        <li><a id="contents:exposing-a-opaquetokenintrospector-bean" href="#exposing-a-opaquetokenintrospector-bean">Exposing a <code>OpaqueTokenIntrospector</code> <code>@Bean</code></a></li>
      </ol>
    </li>
    <li><a id="contents:15configuring-authorization" href="#15configuring-authorization">15Â Configuring Authorization</a>
      <ol>
        <li><a id="contents:extracting-authorities-manually-1" href="#extracting-authorities-manually-1">Extracting Authorities Manually</a></li>
      </ol>
    </li>
    <li><a id="contents:16configuring-timeouts" href="#16configuring-timeouts">16Â Configuring Timeouts</a></li>
    <li><a id="contents:17using-introspection-with-jwts" href="#17using-introspection-with-jwts">17Â Using Introspection with JWTs</a></li>
    <li><a id="contents:18calling-a-userinfo-endpoint" href="#18calling-a-userinfo-endpoint">18Â Calling a <code>/userinfo</code> Endpoint</a></li>
    <li><a id="contents:19supporting-both-jwt-and-opaque-token" href="#19supporting-both-jwt-and-opaque-token">19Â Supporting both JWT and Opaque Token</a></li>
    <li><a id="contents:20multi-tenancy" href="#20multi-tenancy">20Â Multi-tenancy</a>
      <ol>
        <li><a id="contents:resolving-the-tenant-by-request-material" href="#resolving-the-tenant-by-request-material">Resolving the Tenant By Request Material</a></li>
        <li><a id="contents:resolving-the-tenant-by-claim" href="#resolving-the-tenant-by-claim">Resolving the Tenant By Claim</a></li>
        <li><a id="contents:parsing-the-claim-only-once" href="#parsing-the-claim-only-once">Parsing the Claim Only Once</a></li>
      </ol>
    </li>
    <li><a id="contents:21bearer-token-resolution" href="#21bearer-token-resolution">21Â Bearer Token Resolution</a>
      <ol>
        <li><a id="contents:reading-the-bearer-token-from-a-custom-header" href="#reading-the-bearer-token-from-a-custom-header">Reading the Bearer Token from a Custom Header</a></li>
        <li><a id="contents:reading-the-bearer-token-from-a-form-parameter" href="#reading-the-bearer-token-from-a-form-parameter">Reading the Bearer Token from a Form Parameter</a></li>
      </ol>
    </li>
    <li><a id="contents:22bearer-token-propagation" href="#22bearer-token-propagation">22Â Bearer Token Propagation</a>
      <ol>
        <li><a id="contents:resttemplate-support" href="#resttemplate-support"><code>RestTemplate</code> support</a></li>
      </ol>
    </li>
  </ol>
</nav><hr><div class="post-body"><h1 id="spring-security-architecture"><a href="#spring-security-architecture" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:spring-security-architecture" class="headings">Spring Security Architecture</a></h1>
<p>Spring Security æ¶æ„ï¼Œå…¥é—¨ä»‹ç»ï¼š<a href="https://spring.io/guides/topicals/spring-security-architecture/" target="_blank" rel="noopener">ç½‘å€</a></p>
<h2 id="authentication-and-access-control"><a href="#authentication-and-access-control" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:authentication-and-access-control" class="headings">Authentication and Access Control</a></h2>
<p>åº”ç”¨ç¨‹åºå®‰å…¨æ€§å½’ç»“ä¸ºæˆ–å¤šæˆ–å°‘çš„ä¸¤ä¸ªç‹¬ç«‹é—®é¢˜ï¼šèº«ä»½éªŒè¯ï¼ˆæ‚¨æ˜¯è°ï¼Ÿï¼‰å’Œæˆæƒï¼ˆæ‚¨å¯ä»¥åšä»€ä¹ˆï¼Ÿï¼‰ã€‚æœ‰æ—¶äººä»¬ä¼šè¯´â€œè®¿é—®æ§åˆ¶â€è€Œä¸æ˜¯â€œæˆæƒâ€ï¼Œè¿™å¯èƒ½ä¼šé€ æˆæ··æ·†ï¼Œä½†æ˜¯ä»¥è¿™ç§æ–¹å¼æ€è€ƒå¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼Œå› ä¸ºâ€œæˆæƒâ€åœ¨å…¶ä»–åœ°æ–¹è¶…è½½ã€‚ Spring Securityçš„ä½“ç³»ç»“æ„æ—¨åœ¨å°†èº«ä»½éªŒè¯ä¸æˆæƒåˆ†å¼€ï¼Œå¹¶å…·æœ‰ç­–ç•¥å’Œæ‰©å±•ç‚¹ã€‚</p>
<h3 id="authentication"><a href="#authentication" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:authentication" class="headings">Authentication</a></h3>
<p>èº«ä»½éªŒè¯çš„ä¸»è¦ç­–ç•¥æ¥å£æ˜¯AuthenticationManagerï¼Œå®ƒåªæœ‰ä¸€ç§æ–¹æ³•ï¼š</p>
<hr>
<h1 id="oauth-20-resource-server"><a href="#oauth-20-resource-server" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:oauth-20-resource-server" class="headings">Â OAuth 2.0 Resource Server</a></h1>
<p>Spring Security supports protecting endpoints using two forms of OAuth 2.0 <a href="https://tools.ietf.org/html/rfc6750.html" target="_blank" rel="noopener">Bearer Tokens</a>:</p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener">JWT</a></li>
<li>Opaque Tokens</li>
</ul>
<p>This is handy in circumstances where an application has delegated its authority management to an <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">authorization server</a> (for example, Okta or Ping Identity). This authorization server can be consulted by resource servers to authorize requests.</p>
<blockquote>
<p>Working samples for both <a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver" target="_blank" rel="noopener">JWTs</a> and <a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver-opaque" target="_blank" rel="noopener">Opaque Tokens</a> are available in the <a href="https://github.com/spring-projects/spring-security/tree/master/samples" target="_blank" rel="noopener">Spring Security repository</a>.</p>
</blockquote>
<h2 id="1dependencies"><a href="#1dependencies" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:1dependencies" class="headings">1Â Dependencies</a></h2>
<p>Most Resource Server support is collected into <code>spring-security-oauth2-resource-server</code>. However, the support for decoding and verifying JWTs is in <code>spring-security-oauth2-jose</code>, meaning that both are necessary in order to have a working resource server that supports JWT-encoded Bearer Tokens.</p>
<h2 id="2minimal-configuration-for-jwts"><a href="#2minimal-configuration-for-jwts" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:2minimal-configuration-for-jwts" class="headings">2Â Minimal Configuration for JWTs</a></h2>
<p>When using <a href="https://spring.io/projects/spring-boot" target="_blank" rel="noopener">Spring Boot</a>, configuring an application as a resource server consists of two basic steps. First, include the needed dependencies and second, indicate the location of the authorization server.</p>
<h3 id="specifying-the-authorization-server"><a href="#specifying-the-authorization-server" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:specifying-the-authorization-server" class="headings">Specifying the Authorization Server</a></h3>
<p>In a Spring Boot application, to specify which authorization server to use, simply do:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">security</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">oauth2</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">resourceserver</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">jwt</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">issuer-uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//idp.example.com/issuer<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Where <a href="https://idp.example.com/issuer" target="_blank" rel="noopener"><code>https://idp.example.com/issuer</code></a> is the value contained in the <code>iss</code> claim for JWT tokens that the authorization server will issue. Resource Server will use this property to further self-configure, discover the authorization serverâ€™s public keys, and subsequently validate incoming JWTs.</p>
<blockquote>
<p>To use the <code>issuer-uri</code> property, it must also be true that one of <code>https://idp.example.com/issuer/.well-known/openid-configuration</code>, <code>https://idp.example.com/.well-known/openid-configuration/issuer</code>, or <code>https://idp.example.com/.well-known/oauth-authorization-server/issuer</code> is a supported endpoint for the authorization server. This endpoint is referred to as a <a href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig" target="_blank" rel="noopener">Provider Configuration</a> endpoint or a <a href="https://tools.ietf.org/html/rfc8414#section-3" target="_blank" rel="noopener">Authorization Server Metadata</a> endpoint.</p>
</blockquote>
<p>And thatâ€™s it!</p>
<h3 id="startup-expectations"><a href="#startup-expectations" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:startup-expectations" class="headings">Startup Expectations</a></h3>
<p>When this property and these dependencies are used, Resource Server will automatically configure itself to validate JWT-encoded Bearer Tokens. It achieves this through a deterministic startup process:</p>
<ol>
<li>Hit the Provider Configuration or Authorization Server Metadata endpoint, processing the response for the <code>jwks_url</code> property</li>
<li>Configure the validation strategy to query <code>jwks_url</code> for valid public keys</li>
<li>Configure the validation strategy to validate each JWTs <code>iss</code> claim against <a href="https://idp.example.com" target="_blank" rel="noopener"><code>https://idp.example.com</code></a>.</li>
</ol>
<p>A consequence of this process is that the authorization server must be up and receiving requests in order for Resource Server to successfully start up.</p>
<blockquote>
<p>If the authorization server is down when Resource Server queries it (given appropriate timeouts), then startup will fail.</p>
</blockquote>
<h3 id="runtime-expectations"><a href="#runtime-expectations" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:runtime-expectations" class="headings">Runtime Expectations</a></h3>
<p>Once the application is started up, Resource Server will attempt to process any request containing an <code>Authorization: Bearer</code> header:</p>
<pre><code>GET / HTTP/1.1
Authorization: Bearer some-token-value # Resource Server will process this
</code></pre><p>So long as this scheme is indicated, Resource Server will attempt to process the request according to the Bearer Token specification. Given a well-formed JWT, Resource Server will:</p>
<ol>
<li>Validate its signature against a public key obtained from the <code>jwks_url</code> endpoint during startup and matched against the JWTs header</li>
<li>Validate the JWTs <code>exp</code> and <code>nbf</code> timestamps and the JWTs <code>iss</code> claim, and</li>
<li>Map each scope to an authority with the prefix <code>SCOPE_</code>.</li>
</ol>
<blockquote>
<p>As the authorization server makes available new keys, Spring Security will automatically rotate the keys used to validate the JWT tokens.</p>
</blockquote>
<p>The resulting <code>Authentication#getPrincipal</code>, by default, is a Spring Security <code>Jwt</code> object, and <code>Authentication#getName</code> maps to the JWTâ€™s <code>sub</code> property, if one is present. From here, consider jumping to:</p>
<ul>
<li><a href="#oauth2resourceserver-jwt-jwkseturi" title="12.3.3Â Specifying the Authorization Server JWK Set Uri Directly">How to Configure without Tying Resource Server startup to an authorization serverâ€™s availability</a></li>
<li><a href="#oauth2resourceserver-jwt-sansboot" title="12.3.4Â Overriding or Replacing Boot Auto Configuration">How to Configure without Spring Boot</a></li>
</ul>
<h2 id="3specifying-the-authorization-server-jwk-set-uri-directly"><a href="#3specifying-the-authorization-server-jwk-set-uri-directly" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:3specifying-the-authorization-server-jwk-set-uri-directly" class="headings">3Â Specifying the Authorization Server JWK Set Uri Directly</a></h2>
<p>If the authorization server doesnâ€™t support any configuration endpoints, or if Resource Server must be able to start up independently from the authorization server, then the <code>jwk-set-uri</code> can be supplied as well:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">security</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">oauth2</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">resourceserver</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">jwt</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">issuer-uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//idp.example.com<span class="w">
</span><span class="w"> </span><span class="k">jwk-set-uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//idp.example.com/.well-known/jwks.json<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>The JWK Set uri is not standardized, but can typically be found in the authorization serverâ€™s documentation</p>
</blockquote>
<p>Consequently, Resource Server will not ping the authorization server at startup. We still specify the <code>issuer-uri</code> so that Resource Server still validates the <code>iss</code> claim on incoming JWTs.</p>
<blockquote>
<p>This property can also be supplied directly on the <a href="#oauth2resourceserver-jwt-jwkseturi-dsl" title="Using jwkSetUri()">DSL</a>.</p>
</blockquote>
<h2 id="4overriding-or-replacing-boot-auto-configuration"><a href="#4overriding-or-replacing-boot-auto-configuration" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:4overriding-or-replacing-boot-auto-configuration" class="headings">4Â Overriding or Replacing Boot Auto Configuration</a></h2>
<p>There are two <code>@Bean</code> s that Spring Boot generates on Resource Serverâ€™s behalf. The first is a <code>WebSecurityConfigurerAdapter</code> that configures the app as a resource server. When including <code>spring-security-oauth2-jose</code>, this <code>WebSecurityConfigurerAdapter</code> looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">http</span>
        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">.</span><span class="na">and</span><span class="o">()</span>
        <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">(</span><span class="n">OAuth2ResourceServerConfigurer</span><span class="o">::</span><span class="n">jwt</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If the application doesnâ€™t expose a <code>WebSecurityConfigurerAdapter</code> bean, then Spring Boot will expose the above default one. Replacing this is as simple as exposing the bean within the application:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCustomSecurityConfiguration</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&#34;/messages/**&#34;</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&#34;SCOPE_message:read&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">jwt</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">jwtAuthenticationConverter</span><span class="o">(</span><span class="n">myConverter</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above requires the scope of <code>message:read</code> for any URL that starts with <code>/messages/</code>. Methods on the <code>oauth2ResourceServer</code> DSL will also override or replace auto configuration. For example, the second <code>@Bean</code> Spring Boot creates is a <code>JwtDecoder</code>, which decodes <code>String</code> tokens into validated instances of <code>Jwt</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">JwtDecoders</span><span class="o">.</span><span class="na">fromIssuerLocation</span><span class="o">(</span><span class="n">issuerUri</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Calling <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/jwt/JwtDecoders.html#fromIssuerLocation-java.lang.String-" target="_blank" rel="noopener"><code>JwtDecoders#fromIssuerLocation</code></a> is what invokes the Provider Configuration or Authorization Server Metadata endpoint in order to derive the JWK Set Uri.</p>
</blockquote>
<p>If the application doesnâ€™t expose a <code>JwtDecoder</code> bean, then Spring Boot will expose the above default one. And its configuration can be overridden using <code>jwkSetUri()</code> or replaced using <code>decoder()</code>.</p>
<h3 id="using-jwkseturi"><a href="#using-jwkseturi" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:using-jwkseturi" class="headings">Using <code>jwkSetUri()</code></a></h3>
<p>An authorization serverâ€™s JWK Set Uri can be configured <a href="#oauth2resourceserver-jwt-jwkseturi" title="12.3.3Â Specifying the Authorization Server JWK Set Uri Directly">as a configuration property</a> or it can be supplied in the DSL:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectlyConfiguredJwkSetUri</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">jwt</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">jwkSetUri</span><span class="o">(</span><span class="s">&#34;https://idp.example.com/.well-known/jwks.json&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using <code>jwkSetUri()</code> takes precedence over any configuration property.</p>
<h3 id="using-decoder"><a href="#using-decoder" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:using-decoder" class="headings">Using <code>decoder()</code></a></h3>
<p>More powerful than <code>jwkSetUri()</code> is <code>decoder()</code>, which will completely replace any Boot auto configuration of <code>JwtDecoder</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectlyConfiguredJwtDecoder</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">jwt</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="n">myCustomDecoder</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This is handy when deeper configuration, like <a href="#oauth2resourceserver-jwt-validation" title="12.3.9Â Configuring Validation">validation</a>, <a href="#oauth2resourceserver-jwt-claimsetmapping" title="12.3.10Â Configuring Claim Set Mapping">mapping</a>, or <a href="#oauth2resourceserver-jwt-timeouts" title="12.3.11Â Configuring Timeouts">request timeouts</a>, is necessary.</p>
<h3 id="exposing-a-jwtdecoder-bean"><a href="#exposing-a-jwtdecoder-bean" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:exposing-a-jwtdecoder-bean" class="headings">Exposing a <code>JwtDecoder</code> <code>@Bean</code></a></h3>
<p>Or, exposing a <code>JwtDecoder</code> <code>@Bean</code> has the same effect as <code>decoder()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">withJwkSetUri</span><span class="o">(</span><span class="n">jwkSetUri</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="5configuring-trusted-algorithms"><a href="#5configuring-trusted-algorithms" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:5configuring-trusted-algorithms" class="headings">5Â Configuring Trusted Algorithms</a></h2>
<p>By default, <code>NimbusJwtDecoder</code>, and hence Resource Server, will only trust and verify tokens using <code>RS256</code>. You can customize this via <a href="#oauth2resourceserver-jwt-boot-algorithm" title="Via Spring Boot">Spring Boot</a>, <a href="#oauth2resourceserver-jwt-decoder-builder" title="Using a Builder">the NimbusJwtDecoder builder</a>, or from the <a href="#oauth2resourceserver-jwt-decoder-jwk-response" title="From JWK Set response">JWK Set response</a>.</p>
<h3 id="via-spring-boot"><a href="#via-spring-boot" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:via-spring-boot" class="headings">Via Spring Boot</a></h3>
<p>The simplest way to set the algorithm is as a property:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">security</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">oauth2</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">resourceserver</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">jwt</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">jws-algorithm</span><span class="p">:</span><span class="w"> </span>RS512<span class="w">
</span><span class="w">          </span><span class="k">jwk-set-uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//idp.example.org/.well-known/jwks.json<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="using-a-builder"><a href="#using-a-builder" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:using-a-builder" class="headings">Using a Builder</a></h3>
<p>For greater power, though, we can use a builder that ships with <code>NimbusJwtDecoder</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">fromJwkSetUri</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwkSetUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">jwsAlgorithm</span><span class="o">(</span><span class="n">RS512</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Calling <code>jwsAlgorithm</code> more than once will configure <code>NimbusJwtDecoder</code> to trust more than one algorithm, like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">fromJwkSetUri</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwkSetUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">jwsAlgorithm</span><span class="o">(</span><span class="n">RS512</span><span class="o">).</span><span class="na">jwsAlgorithm</span><span class="o">(</span><span class="n">EC512</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Or, you can call <code>jwsAlgorithms</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">fromJwkSetUri</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwkSetUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">jwsAlgorithms</span><span class="o">(</span><span class="n">algorithms</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">algorithms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">RS512</span><span class="o">);</span>
                    <span class="n">algorithms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">EC512</span><span class="o">);</span>
            <span class="o">}).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="from-jwk-set-response"><a href="#from-jwk-set-response" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:from-jwk-set-response" class="headings">From JWK Set response</a></h3>
<p>Since Spring Securityâ€™s JWT support is based off of Nimbus, you can use all itâ€™s great features as well. For example, Nimbus has a <code>JWSKeySelector</code> implementation that will select the set of algorithms based on the JWK Set URI response. You can use it to generate a <code>NimbusJwtDecoder</code> like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// makes a request to the JWK Set endpoint
</span><span class="c1"></span>    <span class="n">JWSKeySelector</span> <span class="o">&lt;</span><span class="n">securitycontext</span><span class="o">&gt;</span><span class="n">jwsKeySelector</span> <span class="o">=</span>
            <span class="n">JWSAlgorithmFamilyJWSKeySelector</span><span class="o">.</span><span class="na">fromJWKSetURL</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jwkSetUrl</span><span class="o">);</span>

    <span class="n">DefaultJWTProcessor</span> <span class="o">&lt;</span><span class="n">securitycontext</span><span class="o">&gt;</span><span class="n">jwtProcessor</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">DefaultJWTProcessor</span><span class="o">&lt;&gt;();</span>
    <span class="n">jwtProcessor</span><span class="o">.</span><span class="na">setJWSKeySelector</span><span class="o">(</span><span class="n">jwsKeySelector</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">NimbusJwtDecoder</span><span class="o">(</span><span class="n">jwtProcessor</span><span class="o">);</span>
<span class="o">}&lt;/</span><span class="n">securitycontext</span><span class="o">&gt;&lt;/</span><span class="n">securitycontext</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="6trusting-a-single-asymmetric-key"><a href="#6trusting-a-single-asymmetric-key" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:6trusting-a-single-asymmetric-key" class="headings">6Â Trusting a Single Asymmetric Key</a></h2>
<p>Simpler than backing a Resource Server with a JWK Set endpoint is to hard-code an RSA public key. The public key can be provided via <a href="#oauth2resourceserver-jwt-decoder-public-key-boot" title="Via Spring Boot">Spring Boot</a> or by <a href="#oauth2resourceserver-jwt-decoder-public-key-builder" title="Using a Builder">Using a Builder</a>.</p>
<h3 id="via-spring-boot-1"><a href="#via-spring-boot-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:via-spring-boot-1" class="headings">Via Spring Boot</a></h3>
<p>Specifying a key via Spring Boot is quite simple. The keyâ€™s location can be specified like so:</p>
<pre><code>spring:
 security:
 oauth2:
 resourceserver:
 jwt:
 public-key-location: classpath:my-key.pub
</code></pre><p>Or, to allow for a more sophisticated lookup, you can post-process the <code>RsaKeyConversionServicePostProcessor</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">BeanFactoryPostProcessor</span> <span class="nf">conversionServiceCustomizer</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">beanFactory</span> <span class="o">-&gt;</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">RsaKeyConversionServicePostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomResourceLoader</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Specify your keyâ€™s location:</p>
<pre><code>key.location: hfds://my-key.pub
</code></pre><p>And then autowire the value:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${key.location}&#34;</span><span class="o">)</span>
<span class="n">RSAPublicKey</span> <span class="n">key</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="using-a-builder-1"><a href="#using-a-builder-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:using-a-builder-1" class="headings">Using a Builder</a></h3>
<p>To wire an <code>RSAPublicKey</code> directly, you can simply use the appropriate <code>NimbusJwtDecoder</code> builder, like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">withPublicKey</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="7trusting-a-single-symmetric-key"><a href="#7trusting-a-single-symmetric-key" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:7trusting-a-single-symmetric-key" class="headings">7Â Trusting a Single Symmetric Key</a></h2>
<p>Using a single symmetric key is also simple. You can simply load in your <code>SecretKey</code> and use the appropriate <code>NimbusJwtDecoder</code> builder, like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">withSecretKey</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="8configuring-authorization"><a href="#8configuring-authorization" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:8configuring-authorization" class="headings">8Â Configuring Authorization</a></h2>
<p>A JWT that is issued from an OAuth 2.0 Authorization Server will typically either have a <code>scope</code> or <code>scp</code> attribute, indicating the scopes (or authorities) itâ€™s been granted, for example: <code>{ â€¦â€‹, &quot;scope&quot; : &quot;messages contacts&quot;}</code> When this is the case, Resource Server will attempt to coerce these scopes into a list of granted authorities, prefixing each scope with the string &quot;SCOPE_&quot;. This means that to protect an endpoint or method with a scope derived from a JWT, the corresponding expressions should include this prefix:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectlyConfiguredJwkSetUri</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">(</span><span class="n">authorizeRequests</span> <span class="o">-&gt;</span> <span class="n">authorizeRequests</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&#34;/contacts/**&#34;</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&#34;SCOPE_contacts&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&#34;/messages/**&#34;</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&#34;SCOPE_messages&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">(</span><span class="n">OAuth2ResourceServerConfigurer</span><span class="o">::</span><span class="n">jwt</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Or similarly with method security:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;hasAuthority(&#39;SCOPE_messages&#39;)&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span> <span class="o">&lt;</span><span class="n">message</span><span class="o">&gt;</span><span class="n">getMessages</span><span class="o">(...)</span> <span class="o">{}&lt;/</span><span class="n">message</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="extracting-authorities-manually"><a href="#extracting-authorities-manually" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:extracting-authorities-manually" class="headings">Extracting Authorities Manually</a></h3>
<p>However, there are a number of circumstances where this default is insufficient. For example, some authorization servers donâ€™t use the <code>scope</code> attribute, but instead have their own custom attribute. Or, at other times, the resource server may need to adapt the attribute or a composition of attributes into internalized authorities. To this end, the DSL exposes <code>jwtAuthenticationConverter()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectlyConfiguredJwkSetUri</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">jwt</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">jwtAuthenticationConverter</span><span class="o">(</span><span class="n">grantedAuthoritiesExtractor</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">Converter</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">,</span> <span class="n">AbstractAuthenticationToken</span><span class="o">&gt;</span> <span class="nf">grantedAuthoritiesExtractor</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">JwtAuthenticationConverter</span> <span class="n">jwtAuthenticationConverter</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">JwtAuthenticationConverter</span><span class="o">();</span>
    <span class="n">jwtAuthenticationConverter</span><span class="o">.</span><span class="na">setJwtGrantedAuthoritiesConverter</span>
            <span class="o">(</span><span class="k">new</span> <span class="n">GrantedAuthoritiesExtractor</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">jwtAuthenticationConveter</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>which is responsible for converting a <code>Jwt</code> into an <code>Authentication</code>. As part of its configuration, we can supply a subsidiary converter to go from <code>Jwt</code> to a <code>Collection</code> of granted authorities. That final converter might be something like <code>GrantedAuthoritiesExtractor</code> below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">GrantedAuthoritiesExtractor</span>
        <span class="kd">implements</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">convert</span><span class="o">(</span><span class="n">Jwt</span> <span class="n">jwt</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;)</span>
                <span class="n">jwt</span><span class="o">.</span><span class="na">getClaims</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;mycustomclaim&#34;</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">authorities</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">SimpleGrantedAuthority</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For more flexibility, the DSL supports entirely replacing the converter with any class that implements <code>Converter&lt;jwt, abstractauthenticationtoken=&quot;&quot;&gt;</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationConverter</span> <span class="kd">implements</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">,</span> <span class="n">AbstractAuthenticationToken</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">AbstractAuthenticationToken</span> <span class="nf">convert</span><span class="o">(</span><span class="n">Jwt</span> <span class="n">jwt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomAuthenticationToken</span><span class="o">(</span><span class="n">jwt</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="9configuring-validation"><a href="#9configuring-validation" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:9configuring-validation" class="headings">9Â Configuring Validation</a></h2>
<p>Using <a href="#oauth2resourceserver-jwt-minimalconfiguration" title="12.3.2Â Minimal Configuration for JWTs">minimal Spring Boot configuration</a>, indicating the authorization serverâ€™s issuer uri, Resource Server will default to verifying the <code>iss</code> claim as well as the <code>exp</code> and <code>nbf</code> timestamp claims. In circumstances where validation needs to be customized, Resource Server ships with two standard validators and also accepts custom <code>OAuth2TokenValidator</code> instances.</p>
<h3 id="customizing-timestamp-validation"><a href="#customizing-timestamp-validation" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:customizing-timestamp-validation" class="headings">Customizing Timestamp Validation</a></h3>
<p>JWTâ€™s typically have a window of validity, with the start of the window indicated in the <code>nbf</code> claim and the end indicated in the <code>exp</code> claim. However, every server can experience clock drift, which can cause tokens to appear expired to one server, but not to another. This can cause some implementation heartburn as the number of collaborating servers increases in a distributed system. Resource Server uses <code>JwtTimestampValidator</code> to verify a tokenâ€™s validity window, and it can be configured with a <code>clockSkew</code> to alleviate the above problem:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">NimbusJwtDecoder</span> <span class="n">jwtDecoder</span> <span class="o">=</span> <span class="o">(</span><span class="n">NimbusJwtDecoder</span><span class="o">)</span>
             <span class="n">JwtDecoders</span><span class="o">.</span><span class="na">fromIssuerLocation</span><span class="o">(</span><span class="n">issuerUri</span><span class="o">);</span>

     <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="n">withClockSkew</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DelegatingOAuth2TokenValidator</span><span class="o">&lt;&gt;(</span>
            <span class="k">new</span> <span class="n">JwtTimestampValidator</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="n">60</span><span class="o">)),</span>
            <span class="k">new</span> <span class="n">IssuerValidator</span><span class="o">(</span><span class="n">issuerUri</span><span class="o">));</span>

     <span class="n">jwtDecoder</span><span class="o">.</span><span class="na">setJwtValidator</span><span class="o">(</span><span class="n">withClockSkew</span><span class="o">);</span>

     <span class="k">return</span> <span class="n">jwtDecoder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>By default, Resource Server configures a clock skew of 30 seconds.</p>
</blockquote>
<h3 id="configuring-a-custom-validator"><a href="#configuring-a-custom-validator" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:configuring-a-custom-validator" class="headings">Configuring a Custom Validator</a></h3>
<p>Adding a check for the <code>aud</code> claim is simple with the <code>OAuth2TokenValidator</code> API:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AudienceValidator</span> <span class="kd">implements</span> <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">OAuth2Error</span> <span class="n">error</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuth2Error</span><span class="o">(</span><span class="s">&#34;invalid_token&#34;</span><span class="o">,</span> <span class="s">&#34;The required audience is missing&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">OAuth2TokenValidatorResult</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Jwt</span> <span class="n">jwt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">jwt</span><span class="o">.</span><span class="na">getAudience</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;messaging&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">OAuth2TokenValidatorResult</span><span class="o">.</span><span class="na">success</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">OAuth2TokenValidatorResult</span><span class="o">.</span><span class="na">failure</span><span class="o">(</span><span class="n">error</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, to add into a resource server, itâ€™s a matter of specifying the <code>JwtDecoder</code> instance:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">NimbusJwtDecoder</span> <span class="n">jwtDecoder</span> <span class="o">=</span> <span class="o">(</span><span class="n">NimbusJwtDecoder</span><span class="o">)</span>
        <span class="n">JwtDecoders</span><span class="o">.</span><span class="na">fromIssuerLocation</span><span class="o">(</span><span class="n">issuerUri</span><span class="o">);</span>

    <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="n">audienceValidator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AudienceValidator</span><span class="o">();</span>
    <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="n">withIssuer</span> <span class="o">=</span> <span class="n">JwtValidators</span><span class="o">.</span><span class="na">createDefaultWithIssuer</span><span class="o">(</span><span class="n">issuerUri</span><span class="o">);</span>
    <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="n">withAudience</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DelegatingOAuth2TokenValidator</span><span class="o">&lt;&gt;(</span><span class="n">withIssuer</span><span class="o">,</span> <span class="n">audienceValidator</span><span class="o">);</span>

    <span class="n">jwtDecoder</span><span class="o">.</span><span class="na">setJwtValidator</span><span class="o">(</span><span class="n">withAudience</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">jwtDecoder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="10configuring-claim-set-mapping"><a href="#10configuring-claim-set-mapping" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:10configuring-claim-set-mapping" class="headings">10Â Configuring Claim Set Mapping</a></h2>
<p>Spring Security uses the <a href="https://bitbucket.org/connect2id/nimbus-jose-jwt/wiki/Home" target="_blank" rel="noopener">Nimbus</a> library for parsing JWTs and validating their signatures. Consequently, Spring Security is subject to Nimbusâ€™s interpretation of each field value and how to coerce each into a Java type. For example, because Nimbus remains Java 7 compatible, it doesnâ€™t use <code>Instant</code> to represent timestamp fields. And itâ€™s entirely possible to use a different library or for JWT processing, which may make its own coercion decisions that need adjustment. Or, quite simply, a resource server may want to add or remove claims from a JWT for domain-specific reasons. For these purposes, Resource Server supports mapping the JWT claim set with <code>MappedJwtClaimSetConverter</code>.</p>
<h3 id="customizing-the-conversion-of-a-single-claim"><a href="#customizing-the-conversion-of-a-single-claim" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:customizing-the-conversion-of-a-single-claim" class="headings">Customizing the Conversion of a Single Claim</a></h3>
<p>By default, <code>MappedJwtClaimSetConverter</code> will attempt to coerce claims into the following types:</p>
<table>
<thead>
<tr>
<th>Claim</th>
<th>Java Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>aud</code></td>
<td><code>Collection</code></td>
</tr>
<tr>
<td><code>exp</code></td>
<td><code>Instant</code></td>
</tr>
<tr>
<td><code>iat</code></td>
<td><code>Instant</code></td>
</tr>
<tr>
<td><code>iss</code></td>
<td><code>String</code></td>
</tr>
<tr>
<td><code>jti</code></td>
<td><code>String</code></td>
</tr>
<tr>
<td><code>nbf</code></td>
<td><code>Instant</code></td>
</tr>
<tr>
<td><code>sub</code></td>
<td><code>String</code></td>
</tr>
</tbody>
</table>
<p>An individual claimâ€™s conversion strategy can be configured using <code>MappedJwtClaimSetConverter.withDefaults</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">NimbusJwtDecoder</span> <span class="n">jwtDecoder</span> <span class="o">=</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">withJwkSetUri</span><span class="o">(</span><span class="n">jwkSetUri</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

    <span class="n">MappedJwtClaimSetConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">MappedJwtClaimSetConverter</span>
            <span class="o">.</span><span class="na">withDefaults</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">&#34;sub&#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">lookupUserIdBySub</span><span class="o">));</span>
    <span class="n">jwtDecoder</span><span class="o">.</span><span class="na">setClaimSetConverter</span><span class="o">(</span><span class="n">converter</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">jwtDecoder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This will keep all the defaults, except it will override the default claim converter for <code>sub</code>.</p>
<h3 id="adding-a-claim"><a href="#adding-a-claim" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:adding-a-claim" class="headings">Adding a Claim</a></h3>
<p><code>MappedJwtClaimSetConverter</code> can also be used to add a custom claim, for example, to adapt to an existing system:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">MappedJwtClaimSetConverter</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">&#34;custom&#34;</span><span class="o">,</span> <span class="n">custom</span> <span class="o">-&gt;</span> <span class="s">&#34;value&#34;</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="removing-a-claim"><a href="#removing-a-claim" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:removing-a-claim" class="headings">Removing a Claim</a></h3>
<p>And removing a claim is also simple, using the same API:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">MappedJwtClaimSetConverter</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">&#34;legacyclaim&#34;</span><span class="o">,</span> <span class="n">legacy</span> <span class="o">-&gt;</span> <span class="kc">null</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="renaming-a-claim"><a href="#renaming-a-claim" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:renaming-a-claim" class="headings">Renaming a Claim</a></h3>
<p>In more sophisticated scenarios, like consulting multiple claims at once or renaming a claim, Resource Server accepts any class that implements <code>Converter&lt;map&lt;string, object=&quot;&quot;&gt;, Map&lt;string,object&gt;&gt;</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsernameSubClaimAdapter</span> <span class="kd">implements</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MappedJwtClaimSetConverter</span> <span class="n">delegate</span> <span class="o">=</span>
            <span class="n">MappedJwtClaimSetConverter</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">());</span>

    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">convert</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">convertedClaims</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">convertedClaims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;user_name&#34;</span><span class="o">);</span>
        <span class="n">convertedClaims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;sub&#34;</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">convertedClaims</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>And then, the instance can be supplied like normal:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">NimbusJwtDecoder</span> <span class="n">jwtDecoder</span> <span class="o">=</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">withJwkSetUri</span><span class="o">(</span><span class="n">jwkSetUri</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="n">jwtDecoder</span><span class="o">.</span><span class="na">setClaimSetConverter</span><span class="o">(</span><span class="k">new</span> <span class="n">UsernameSubClaimAdapter</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">jwtDecoder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="11configuring-timeouts"><a href="#11configuring-timeouts" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:11configuring-timeouts" class="headings">11Â Configuring Timeouts</a></h2>
<p>By default, Resource Server uses connection and socket timeouts of 30 seconds each for coordinating with the authorization server. This may be too short in some scenarios. Further, it doesnâ€™t take into account more sophisticated patterns like back-off and discovery. To adjust the way in which Resource Server connects to the authorization server, <code>NimbusJwtDecoder</code> accepts an instance of <code>RestOperations</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">(</span><span class="n">RestTemplateBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RestOperations</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">builder</span>
            <span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="n">60000</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">60000</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">NimbusJwtDecoder</span> <span class="n">jwtDecoder</span> <span class="o">=</span> <span class="n">NimbusJwtDecoder</span><span class="o">.</span><span class="na">withJwkSetUri</span><span class="o">(</span><span class="n">jwkSetUri</span><span class="o">).</span><span class="na">restOperations</span><span class="o">(</span><span class="n">rest</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">jwtDecoder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="12minimal-configuration-for-introspection"><a href="#12minimal-configuration-for-introspection" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:12minimal-configuration-for-introspection" class="headings">12Â Minimal Configuration for Introspection</a></h2>
<p>Typically, an opaque token can be verified via an <a href="https://tools.ietf.org/html/rfc7662" target="_blank" rel="noopener">OAuth 2.0 Introspection Endpoint</a>, hosted by the authorization server. This can be handy when revocation is a requirement. When using <a href="https://spring.io/projects/spring-boot" target="_blank" rel="noopener">Spring Boot</a>, configuring an application as a resource server that uses introspection consists of two basic steps. First, include the needed dependencies and second, indicate the introspection endpoint details.</p>
<h3 id="specifying-the-authorization-server-1"><a href="#specifying-the-authorization-server-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:specifying-the-authorization-server-1" class="headings">Specifying the Authorization Server</a></h3>
<p>To specify where the introspection endpoint is, simply do:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">security</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">oauth2</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">resourceserver</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">opaque-token</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">introspection-uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//idp.example.com/introspect<span class="w">
</span><span class="w"> </span><span class="k">client-id</span><span class="p">:</span><span class="w"> </span>client<span class="w">
</span><span class="w"> </span><span class="k">client-secret</span><span class="p">:</span><span class="w"> </span>secret<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Where <a href="https://idp.example.com/introspect" target="_blank" rel="noopener"><code>https://idp.example.com/introspect</code></a> is the introspection endpoint hosted by your authorization server and <code>client-id</code> and <code>client-secret</code> are the credentials needed to hit that endpoint. Resource Server will use these properties to further self-configure and subsequently validate incoming JWTs.</p>
<blockquote>
<p>When using introspection, the authorization serverâ€™s word is the law. If the authorization server responses that the token is valid, then it is.</p>
</blockquote>
<p>And thatâ€™s it!</p>
<h3 id="startup-expectations-1"><a href="#startup-expectations-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:startup-expectations-1" class="headings">Startup Expectations</a></h3>
<p>When this property and these dependencies are used, Resource Server will automatically configure itself to validate Opaque Bearer Tokens. This startup process is quite a bit simpler than for JWTs since no endpoints need to be discovered and no additional validation rules get added.</p>
<h3 id="runtime-expectations-1"><a href="#runtime-expectations-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:runtime-expectations-1" class="headings">Runtime Expectations</a></h3>
<p>Once the application is started up, Resource Server will attempt to process any request containing an <code>Authorization: Bearer</code> header:</p>
<pre><code>GET / HTTP/1.1
Authorization: Bearer some-token-value # Resource Server will process this
</code></pre><p>So long as this scheme is indicated, Resource Server will attempt to process the request according to the Bearer Token specification. Given an Opaque Token, Resource Server will</p>
<ol>
<li>Query the provided introspection endpoint using the provided credentials and the token</li>
<li>Inspect the response for an <code>{ 'active' : true }</code> attribute</li>
<li>Map each scope to an authority with the prefix <code>SCOPE_</code></li>
</ol>
<p>The resulting <code>Authentication#getPrincipal</code>, by default, is a Spring Security <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/core/OAuth2AuthenticatedPrincipal.html" target="_blank" rel="noopener"><code>OAuth2AuthenticatedPrincipal</code></a> object, and <code>Authentication#getName</code> maps to the tokenâ€™s <code>sub</code> property, if one is present. From here, you may want to jump to:</p>
<ul>
<li><a href="#oauth2resourceserver-opaque-attributes" title="12.3.13Â Looking Up Attributes Post-Authentication">Looking Up Attributes Post-Authentication</a></li>
<li><a href="#oauth2resourceserver-opaque-authorization-extraction" title="Extracting Authorities Manually">Extracting Authorities Manually</a></li>
<li><a href="#oauth2resourceserver-opaque-jwt-introspector" title="12.3.17Â Using Introspection with JWTs">Using Introspection with JWTs</a></li>
</ul>
<h2 id="13looking-up-attributes-post-authentication"><a href="#13looking-up-attributes-post-authentication" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:13looking-up-attributes-post-authentication" class="headings">13Â Looking Up Attributes Post-Authentication</a></h2>
<p>Once a token is authenticated, an instance of <code>BearerTokenAuthentication</code> is set in the <code>SecurityContext</code>. This means that itâ€™s available in <code>@Controller</code> methods when using <code>@EnableWebMvc</code> in your configuration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/foo&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">foo</span><span class="o">(</span><span class="n">BearerTokenAuthentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getTokenAttributes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sub&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; is the subject&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Since <code>BearerTokenAuthentication</code> holds an <code>OAuth2AuthenticatedPrincipal</code>, that also means that itâ€™s available to controller methods, too:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/foo&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">foo</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">principal</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;sub&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; is the subject&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="looking-up-attributes-via-spel"><a href="#looking-up-attributes-via-spel" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:looking-up-attributes-via-spel" class="headings">Looking Up Attributes Via SpEL</a></h3>
<p>Of course, this also means that attributes can be accessed via SpEL. For example, if using <code>@EnableGlobalMethodSecurity</code> so that you can use <code>@PreAuthorize</code> annotations, you can do:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;principal?.attributes[&#39;sub&#39;] == &#39;foo&#39;&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">forFoosEyesOnly</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&#34;foo&#34;</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="14overriding-or-replacing-boot-auto-configuration"><a href="#14overriding-or-replacing-boot-auto-configuration" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:14overriding-or-replacing-boot-auto-configuration" class="headings">14Â Overriding or Replacing Boot Auto Configuration</a></h2>
<p>There are two <code>@Bean</code> s that Spring Boot generates on Resource Serverâ€™s behalf. The first is a <code>WebSecurityConfigurerAdapter</code> that configures the app as a resource server. When use Opaque Token, this <code>WebSecurityConfigurerAdapter</code> looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">http</span>
        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">.</span><span class="na">and</span><span class="o">()</span>
        <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">(</span><span class="n">OAuth2ResourceServerConfigurer</span><span class="o">::</span><span class="n">opaqueToken</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If the application doesnâ€™t expose a <code>WebSecurityConfigurerAdapter</code> bean, then Spring Boot will expose the above default one. Replacing this is as simple as exposing the bean within the application:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCustomSecurityConfiguration</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&#34;/messages/**&#34;</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&#34;SCOPE_message:read&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">opaqueToken</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">introspector</span><span class="o">(</span><span class="n">myIntrospector</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above requires the scope of <code>message:read</code> for any URL that starts with <code>/messages/</code>. Methods on the <code>oauth2ResourceServer</code> DSL will also override or replace auto configuration. For example, the second <code>@Bean</code> Spring Boot creates is an <code>OpaqueTokenIntrospector</code>, which decodes <code>String</code> tokens into validated instances of <code>OAuth2AuthenticatedPrincipal</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">OpaqueTokenIntrospector</span> <span class="nf">introspector</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="n">introspectionUri</span><span class="o">,</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If the application doesnâ€™t expose a <code>OpaqueTokenIntrospector</code> bean, then Spring Boot will expose the above default one. And its configuration can be overridden using <code>introspectionUri()</code> and <code>introspectionClientCredentials()</code> or replaced using <code>introspector()</code>.</p>
<h3 id="using-introspectionuri"><a href="#using-introspectionuri" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:using-introspectionuri" class="headings">Using <code>introspectionUri()</code></a></h3>
<p>An authorization serverâ€™s Introspection Uri can be configured <a href="#">as a configuration property</a> or it can be supplied in the DSL:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectlyConfiguredIntrospectionUri</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">opaqueToken</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">introspectionUri</span><span class="o">(</span><span class="s">&#34;https://idp.example.com/introspect&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">introspectionClientCredentials</span><span class="o">(</span><span class="s">&#34;client&#34;</span><span class="o">,</span> <span class="s">&#34;secret&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using <code>introspectionUri()</code> takes precedence over any configuration property.</p>
<h3 id="using-introspector"><a href="#using-introspector" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:using-introspector" class="headings">Using <code>introspector()</code></a></h3>
<p>More powerful than <code>introspectionUri()</code> is <code>introspector()</code>, which will completely replace any Boot auto configuration of <code>OpaqueTokenIntrospector</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectlyConfiguredIntrospector</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
                <span class="o">.</span><span class="na">opaqueToken</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">introspector</span><span class="o">(</span><span class="n">myCustomIntrospector</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This is handy when deeper configuration, like <a href="#oauth2resourceserver-opaque-authorization-extraction" title="Extracting Authorities Manually">authority mapping</a>, <a href="#oauth2resourceserver-opaque-jwt-introspector" title="12.3.17Â Using Introspection with JWTs">JWT revocation</a>, or <a href="#oauth2resourceserver-opaque-timeouts" title="12.3.16Â Configuring Timeouts">request timeouts</a>, is necessary.</p>
<h3 id="exposing-a-opaquetokenintrospector-bean"><a href="#exposing-a-opaquetokenintrospector-bean" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:exposing-a-opaquetokenintrospector-bean" class="headings">Exposing a <code>OpaqueTokenIntrospector</code> <code>@Bean</code></a></h3>
<p>Or, exposing a <code>OpaqueTokenIntrospector</code> <code>@Bean</code> has the same effect as <code>introspector()</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">OpaqueTokenIntrospector</span> <span class="nf">introspector</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="n">introspectionUri</span><span class="o">,</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="15configuring-authorization"><a href="#15configuring-authorization" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:15configuring-authorization" class="headings">15Â Configuring Authorization</a></h2>
<p>An OAuth 2.0 Introspection endpoint will typically return a <code>scope</code> attribute, indicating the scopes (or authorities) itâ€™s been granted, for example: <code>{ â€¦â€‹, &quot;scope&quot; : &quot;messages contacts&quot;}</code> When this is the case, Resource Server will attempt to coerce these scopes into a list of granted authorities, prefixing each scope with the string &quot;SCOPE_&quot;. This means that to protect an endpoint or method with a scope derived from an Opaque Token, the corresponding expressions should include this prefix:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MappedAuthorities</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">(</span><span class="n">authorizeRequests</span> <span class="o">-&gt;</span> <span class="n">authorizeRequests</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&#34;/contacts/**&#34;</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&#34;SCOPE_contacts&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&#34;/messages/**&#34;</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&#34;SCOPE_messages&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">(</span><span class="n">OAuth2ResourceServerConfigurer</span><span class="o">::</span><span class="n">opaqueToken</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Or similarly with method security:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">&#34;hasAuthority(&#39;SCOPE_messages&#39;)&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">(...)</span> <span class="o">{}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="extracting-authorities-manually-1"><a href="#extracting-authorities-manually-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:extracting-authorities-manually-1" class="headings">Extracting Authorities Manually</a></h3>
<p>By default, Opaque Token support will extract the scope claim from an introspection response and parse it into individual <code>GrantedAuthority</code> instances. For example, if the introspection response were:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;active&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&#34;scope&#34;</span> <span class="p">:</span> <span class="s2">&#34;message:read message:write&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then Resource Server would generate an <code>Authentication</code> with two authorities, one for <code>message:read</code> and the other for <code>message:write</code>. This can, of course, be customized using a custom <code>OpaqueTokenIntrospector</code> that takes a look at the attribute set and converts in its own way:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthoritiesOpaqueTokenIntrospector</span> <span class="kd">implements</span> <span class="n">OpaqueTokenIntrospector</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">OpaqueTokenIntrospector</span> <span class="n">delegate</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="s">&#34;https://idp.example.org/introspect&#34;</span><span class="o">,</span> <span class="s">&#34;client&#34;</span><span class="o">,</span> <span class="s">&#34;secret&#34;</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="nf">introspect</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="n">principal</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">introspect</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultOAuth2AuthenticatedPrincipal</span><span class="o">(</span>
                <span class="n">principal</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">principal</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">(),</span> <span class="n">extractAuthorities</span><span class="o">(</span><span class="n">principal</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">extractAuthorities</span><span class="o">(</span><span class="n">OAuth2AuthenticatedPrincipal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">scopes</span> <span class="o">=</span> <span class="n">principal</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">OAuth2IntrospectionClaimNames</span><span class="o">.</span><span class="na">SCOPE</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">scopes</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">SimpleGrantedAuthority</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Thereafter, this custom introspector can be configured simply by exposing it as a <code>@Bean</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">OpaqueTokenIntrospector</span> <span class="nf">introspector</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">CustomAuthoritiesOpaqueTokenIntrospector</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="16configuring-timeouts"><a href="#16configuring-timeouts" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:16configuring-timeouts" class="headings">16Â Configuring Timeouts</a></h2>
<p>By default, Resource Server uses connection and socket timeouts of 30 seconds each for coordinating with the authorization server. This may be too short in some scenarios. Further, it doesnâ€™t take into account more sophisticated patterns like back-off and discovery. To adjust the way in which Resource Server connects to the authorization server, <code>NimbusOpaqueTokenIntrospector</code> accepts an instance of <code>RestOperations</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">OpaqueTokenIntrospector</span> <span class="nf">introspector</span><span class="o">(</span><span class="n">RestTemplateBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RestOperations</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">builder</span>
            <span class="o">.</span><span class="na">basicAuthentication</span><span class="o">(</span><span class="n">clientId</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="n">60000</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">60000</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="n">introspectionUri</span><span class="o">,</span> <span class="n">rest</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="17using-introspection-with-jwts"><a href="#17using-introspection-with-jwts" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:17using-introspection-with-jwts" class="headings">17Â Using Introspection with JWTs</a></h2>
<p>A common question is whether or not introspection is compatible with JWTs. Spring Securityâ€™s Opaque Token support has been designed to not care about the format of the tokenâ€‰â€”â€‰it will gladly pass any token to the introspection endpoint provided. So, letâ€™s say that youâ€™ve got a requirement that requires you to check with the authorization server on each request, in case the JWT has been revoked. Even though you are using the JWT format for the token, your validation method is introspection, meaning youâ€™d want to do:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">security</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">oauth2</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">resourceserver</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">opaque-token</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">introspection-uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//idp.example.org/introspection<span class="w">
</span><span class="w"> </span><span class="k">client-id</span><span class="p">:</span><span class="w"> </span>client<span class="w">
</span><span class="w"> </span><span class="k">client-secret</span><span class="p">:</span><span class="w"> </span>secret<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In this case, the resulting <code>Authentication</code> would be <code>BearerTokenAuthentication</code>. Any attributes in the corresponding <code>OAuth2AuthenticatedPrincipal</code> would be whatever was returned by the introspection endpoint. But, letâ€™s say that, oddly enough, the introspection endpoint only returns whether or not the token is active. Now what? In this case, you can create a custom <code>OpaqueTokenIntrospector</code> that still hits the endpoint, but then updates the returned principal to have the JWTs claims as the attributes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtOpaqueTokenIntrospector</span> <span class="kd">implements</span> <span class="n">OpaqueTokenIntrospector</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">OpaqueTokenIntrospector</span> <span class="n">delegate</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="s">&#34;https://idp.example.org/introspect&#34;</span><span class="o">,</span> <span class="s">&#34;client&#34;</span><span class="o">,</span> <span class="s">&#34;secret&#34;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="n">JwtDecoder</span> <span class="n">jwtDecoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NimbusJwtDecoder</span><span class="o">(</span><span class="k">new</span> <span class="n">ParseOnlyJWTProcessor</span><span class="o">());</span>

    <span class="kd">public</span> <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="nf">introspect</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="n">principal</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">introspect</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Jwt</span> <span class="n">jwt</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">jwtDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultOAuth2AuthenticatedPrincipal</span><span class="o">(</span><span class="n">jwt</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(),</span> <span class="n">NO_AUTHORITIES</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JwtException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">OAuth2IntrospectionException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ParseOnlyJWTProcessor</span> <span class="kd">extends</span> <span class="n">DefaultJWTProcessor</span><span class="o">&lt;</span><span class="n">SecurityContext</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="n">JWTClaimsSet</span> <span class="nf">process</span><span class="o">(</span><span class="n">SignedJWT</span> <span class="n">jwt</span><span class="o">,</span> <span class="n">SecurityContext</span> <span class="n">context</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">JOSEException</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getJWTClaimSet</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Thereafter, this custom introspector can be configured simply by exposing it as a <code>@Bean</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">OpaqueTokenIntrospector</span> <span class="nf">introspector</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">JwtOpaqueTokenIntropsector</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="18calling-a-userinfo-endpoint"><a href="#18calling-a-userinfo-endpoint" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:18calling-a-userinfo-endpoint" class="headings">18Â Calling a <code>/userinfo</code> Endpoint</a></h2>
<p>Generally speaking, a Resource Server doesnâ€™t care about the underlying user, but instead about the authorities that have been granted. That said, at times it can be valuable to tie the authorization statement back to a user. If an application is also using <code>spring-security-oauth2-client</code>, having set up the appropriate <code>ClientRegistrationRepository</code>, then this is quite simple with a custom <code>OpaqueTokenIntrospector</code>. This implementation below does three things:</p>
<ul>
<li>Delegates to the introspection endpoint, to affirm the tokenâ€™s validity</li>
<li>Looks up the appropriate client registration associated with the <code>/userinfo</code> endpoint</li>
<li>Invokes and returns the response from the <code>/userinfo</code> endpoint</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserInfoOpaqueTokenIntrospector</span> <span class="kd">implements</span> <span class="n">OpaqueTokenIntrospector</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">OpaqueTokenIntrospector</span> <span class="n">delegate</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="s">&#34;https://idp.example.org/introspect&#34;</span><span class="o">,</span> <span class="s">&#34;client&#34;</span><span class="o">,</span> <span class="s">&#34;secret&#34;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">OAuth2UserService</span> <span class="n">oauth2UserService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultOAuth2UserService</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ClientRegistrationRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="c1">// ... constructor
</span><span class="c1"></span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="nf">introspect</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="n">authorized</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">introspect</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">Instant</span> <span class="n">issuedAt</span> <span class="o">=</span> <span class="n">authorized</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">ISSUED_AT</span><span class="o">);</span>
        <span class="n">Instant</span> <span class="n">expiresAt</span> <span class="o">=</span> <span class="n">authorized</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">EXPIRES_AT</span><span class="o">);</span>
        <span class="n">ClientRegistration</span> <span class="n">clientRegistration</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">findByRegistrationId</span><span class="o">(</span><span class="s">&#34;registration-id&#34;</span><span class="o">);</span>
        <span class="n">OAuth2AccessToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuth2AccessToken</span><span class="o">(</span><span class="n">BEARER</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">issuedAt</span><span class="o">,</span> <span class="n">expiresAt</span><span class="o">);</span>
        <span class="n">OAuth2UserRequest</span> <span class="n">oauth2UserRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OAuth2UserRequest</span><span class="o">(</span><span class="n">clientRegistration</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">oauth2UserService</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">oauth2UserRequest</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If you arenâ€™t using <code>spring-security-oauth2-client</code>, itâ€™s still quite simple. You will simply need to invoke the <code>/userinfo</code> with your own instance of <code>WebClient</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserInfoOpaqueTokenIntrospector</span> <span class="kd">implements</span> <span class="n">OpaqueTokenIntrospector</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">OpaqueTokenIntrospector</span> <span class="n">delegate</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">NimbusOpaqueTokenIntrospector</span><span class="o">(</span><span class="s">&#34;https://idp.example.org/introspect&#34;</span><span class="o">,</span> <span class="s">&#34;client&#34;</span><span class="o">,</span> <span class="s">&#34;secret&#34;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">WebClient</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="nf">introspect</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OAuth2AuthenticatedPrincipal</span> <span class="n">authorized</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">introspect</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">makeUserInfoRequest</span><span class="o">(</span><span class="n">authorized</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Either way, having created your <code>OpaqueTokenIntrospector</code>, you should publish it as a <code>@Bean</code> to override the defaults:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">OpaqueTokenIntrospector</span> <span class="nf">introspector</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">UserInfoOpaqueTokenIntrospector</span><span class="o">(...);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="19supporting-both-jwt-and-opaque-token"><a href="#19supporting-both-jwt-and-opaque-token" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:19supporting-both-jwt-and-opaque-token" class="headings">19Â Supporting both JWT and Opaque Token</a></h2>
<p>In some cases, you may have a need to access both kinds of tokens. For example, you may support more than one tenant where one tenant issues JWTs and the other issues opaque tokens. If this decision must be made at request-time, then you can use an <code>AuthenticationManagerResolver</code> to achieve it, like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">AuthenticationManagerResolver</span><span class="o">&lt;</span><span class="n">HttpServletRequest</span><span class="o">&gt;</span> <span class="nf">tokenAuthenticationManagerResolver</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">BearerTokenResolver</span> <span class="n">bearerToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultBearerTokenResolver</span><span class="o">();</span>
    <span class="n">JwtAuthenticationProvider</span> <span class="n">jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">();</span>
    <span class="n">OpaqueTokenAuthenticationProvider</span> <span class="n">opaqueToken</span> <span class="o">=</span> <span class="n">opaqueToken</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">request</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">bearerToken</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isAJwt</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">jwt</span><span class="o">::</span><span class="n">authenticate</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">opaqueToken</span><span class="o">::</span><span class="n">authenticate</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>And then specify this <code>AuthenticationManagerResolver</code> in the DSL:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">http</span>
    <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
        <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
        <span class="o">.</span><span class="na">authenticationManagerResolver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tokenAuthenticationManagerResolver</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="20multi-tenancy"><a href="#20multi-tenancy" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:20multi-tenancy" class="headings">20Â Multi-tenancy</a></h2>
<p>A resource server is considered multi-tenant when there are multiple strategies for verifying a bearer token, keyed by some tenant identifier. For example, your resource server may accept bearer tokens from two different authorization servers. Or, your authorization server may represent a multiplicity of issuers. In each case, there are two things that need to be done and trade-offs associated with how you choose to do them:</p>
<ol>
<li>Resolve the tenant</li>
<li>Propagate the tenant</li>
</ol>
<h3 id="resolving-the-tenant-by-request-material"><a href="#resolving-the-tenant-by-request-material" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:resolving-the-tenant-by-request-material" class="headings">Resolving the Tenant By Request Material</a></h3>
<p>Resolving the tenant by request material can be done my implementing an <code>AuthenticationManagerResolver</code>, which determines the <code>AuthenticationManager</code> at runtime, like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TenantAuthenticationManagerResolver</span>
        <span class="kd">implements</span> <span class="n">AuthenticationManagerResolver</span><span class="o">&lt;</span><span class="n">HttpServletRequest</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BearerTokenResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultBearerTokenResolver</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">;</span> <span class="c1">// 1
</span><span class="c1"></span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AuthenticationManager</span><span class="o">&gt;</span> <span class="n">authenticationManagers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span> <span class="c1">// 2
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="nf">TenantAuthenticationManagerResolver</span><span class="o">(</span><span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenants</span> <span class="o">=</span> <span class="n">tenants</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">authenticationManagers</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">toTenant</span><span class="o">(</span><span class="n">request</span><span class="o">),</span> <span class="k">this</span><span class="o">::</span><span class="n">fromTenant</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">toTenant</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">pathParts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">pathParts</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">pathParts</span><span class="o">[</span><span class="n">1</span><span class="o">]</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">AuthenticationManager</span> <span class="nf">fromTenant</span><span class="o">(</span><span class="n">String</span> <span class="n">tenant</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tenants</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span> <span class="c1">// 3
</span><span class="c1"></span>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">JwtDecoders</span><span class="o">::</span><span class="n">fromIssuerLocation</span><span class="o">)</span> <span class="c1">// 4
</span><span class="c1"></span>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">JwtAuthenticationProvider</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;unknown tenant&#34;</span><span class="o">))::</span><span class="n">authenticate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>A hypothetical source for tenant information</li>
<li>A cache for <code>AuthenticationManager</code>s, keyed by tenant identifier</li>
<li>Looking up the tenant is more secure than simply computing the issuer location on the fly - the lookup acts as a tenant whitelist</li>
<li>Create a JwtDecoder via the discovery endpoint - the lazy lookup here means that you donâ€™t need to configure all tenants at startup</li>
</ol>
<p>And then specify this <code>AuthenticationManagerResolver</code> in the DSL:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">http</span>
    <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
        <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
        <span class="o">.</span><span class="na">authenticationManagerResolver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tenantAuthenticationManagerResolver</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="resolving-the-tenant-by-claim"><a href="#resolving-the-tenant-by-claim" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:resolving-the-tenant-by-claim" class="headings">Resolving the Tenant By Claim</a></h3>
<p>Resolving the tenant by claim is similar to doing so by request material. The only real difference is the <code>toTenant</code> method implementation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TenantAuthenticationManagerResolver</span> <span class="kd">implements</span> <span class="n">AuthenticationManagerResolver</span><span class="o">&lt;</span><span class="n">HttpServletRequest</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BearerTokenResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultBearerTokenResolver</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">;</span> <span class="c1">// 1
</span><span class="c1"></span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">AuthenticationManager</span><span class="o">&gt;</span> <span class="n">authenticationManagers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span> <span class="c1">// 2
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="nf">TenantAuthenticationManagerResolver</span><span class="o">(</span><span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenants</span> <span class="o">=</span> <span class="n">tenants</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">resolve</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">authenticationManagers</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">toTenant</span><span class="o">(</span><span class="n">request</span><span class="o">),</span> <span class="k">this</span><span class="o">::</span><span class="n">fromTenant</span><span class="o">);</span> <span class="c1">// 3
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">toTenant</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resolver</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">JWTParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">getJWTClaimsSet</span><span class="o">().</span><span class="na">getIssuer</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">AuthenticationManager</span> <span class="nf">fromTenant</span><span class="o">(</span><span class="n">String</span> <span class="n">tenant</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tenants</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span> <span class="c1">// 4
</span><span class="c1"></span>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">JwtDecoders</span><span class="o">::</span><span class="n">fromIssuerLocation</span><span class="o">)</span> <span class="c1">// 5
</span><span class="c1"></span>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">JwtAuthenticationProvider</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;unknown tenant&#34;</span><span class="o">))::</span><span class="n">authenticate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#CO14-1"><img src="images/1.png" alt="1"></a></td>
<td></td>
<td>A hypothetical source for tenant information</td>
</tr>
<tr>
<td><a href="#CO14-2"><img src="images/2.png" alt="1"></a></td>
<td></td>
<td>A cache for <code>AuthenticationManager</code>s, keyed by tenant identifier</td>
</tr>
<tr>
<td><a href="#CO14-3"><img src="images/3.png" alt="1"></a></td>
<td><a href="#CO14-4"><img src="images/4.png" alt="1"></a></td>
<td>Looking up the tenant is more secure than simply computing the issuer location on the fly - the lookup acts as a tenant whitelist</td>
</tr>
<tr>
<td><a href="#CO14-5"><img src="images/5.png" alt="1"></a></td>
<td></td>
<td>Create a <code>JwtDecoder</code> via the discovery endpoint - the lazy lookup here means that you donâ€™t need to configure all tenants at startup</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">http</span>
    <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
        <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
        <span class="o">.</span><span class="na">authenticationManagerResolver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tenantAuthenticationManagerResolver</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="parsing-the-claim-only-once"><a href="#parsing-the-claim-only-once" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:parsing-the-claim-only-once" class="headings">Parsing the Claim Only Once</a></h3>
<p>You may have observed that this strategy, while simple, comes with the trade-off that the JWT is parsed once by the <code>AuthenticationManagerResolver</code> and then again by the <code>JwtDecoder</code>. This extra parsing can be alleviated by configuring the <code>JwtDecoder</code> directly with a <code>JWTClaimSetAwareJWSKeySelector</code> from Nimbus:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TenantJWSKeySelector</span>
    <span class="kd">implements</span> <span class="n">JWTClaimSetAwareJWSKeySelector</span><span class="o">&lt;</span><span class="n">SecurityContext</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">;</span> <span class="n">1</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">JWSKeySelector</span><span class="o">&lt;</span><span class="n">SecurityContext</span><span class="o">&gt;&gt;</span> <span class="n">selectors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span> <span class="n">2</span>

    <span class="kd">public</span> <span class="nf">TenantJWSKeySelector</span><span class="o">(</span><span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenants</span> <span class="o">=</span> <span class="n">tenants</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Key</span><span class="o">&gt;</span> <span class="nf">selectKeys</span><span class="o">(</span><span class="n">JWSHeader</span> <span class="n">jwsHeader</span><span class="o">,</span> <span class="n">JWTClaimsSet</span> <span class="n">jwtClaimsSet</span><span class="o">,</span> <span class="n">SecurityContext</span> <span class="n">securityContext</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">KeySourceException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">selectors</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">toTenant</span><span class="o">(</span><span class="n">jwtClaimsSet</span><span class="o">),</span> <span class="k">this</span><span class="o">::</span><span class="n">fromTenant</span><span class="o">)</span>
                <span class="o">.</span><span class="na">selectJWSKeys</span><span class="o">(</span><span class="n">jwsHeader</span><span class="o">,</span> <span class="n">securityContext</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">toTenant</span><span class="o">(</span><span class="n">JWTClaimsSet</span> <span class="n">claimSet</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">claimSet</span><span class="o">.</span><span class="na">getClaim</span><span class="o">(</span><span class="s">&#34;iss&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">JWSKeySelector</span><span class="o">&lt;</span><span class="n">SecurityContext</span><span class="o">&gt;</span> <span class="nf">fromTenant</span><span class="o">(</span><span class="n">String</span> <span class="n">tenant</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tenantRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span> <span class="n">3</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">getAttrbute</span><span class="o">(</span><span class="s">&#34;jwks_uri&#34;</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">fromUri</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;unknown tenant&#34;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">JWSKeySelector</span><span class="o">&lt;</span><span class="n">SecurityContext</span><span class="o">&gt;</span> <span class="nf">fromUri</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">JWSAlgorithmFamilyJWSKeySelector</span><span class="o">.</span><span class="na">fromJWKSetURL</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">uri</span><span class="o">));</span> <span class="n">4</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="#CO14-1"><img src="images/1.png" alt="1"></a></td>
<td>A hypothetical source for tenant information</td>
<td></td>
</tr>
<tr>
<td><a href="#CO14-2"><img src="images/2.png" alt="1"></a></td>
<td>A cache for <code>JWKKeySelector</code>s, keyed by tenant identifier</td>
<td></td>
</tr>
<tr>
<td><a href="#CO14-3"><img src="images/3.png" alt="1"></a></td>
<td>Looking up the tenant is more secure than simply calculating the JWK Set endpoint on the fly - the lookup acts as a tenant whitelist</td>
<td></td>
</tr>
<tr>
<td><a href="#CO14-4"><img src="images/4.png" alt="1"></a></td>
<td>Create a <code>JWSKeySelector</code> via the types of keys that come back from the JWK Set endpoint - the lazy lookup here means that you donâ€™t need to configure all tenants at startupp</td>
<td></td>
</tr>
</tbody>
</table>
<p>The above key selector is a composition of many key selectors. It chooses which key selector to use based on the <code>iss</code> claim in the JWT.</p>
<blockquote>
<p>To use this approach, make sure that the authorization server is configured to include the claim set as part of the tokenâ€™s signature. Without this, you have no guarantee that the issuer hasnâ€™t been altered by a bad actor.</p>
</blockquote>
<p>Next, we can construct a <code>JWTProcessor</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JWTProcessor</span> <span class="nf">jwtProcessor</span><span class="o">(</span><span class="n">JWTClaimSetJWSKeySelector</span> <span class="n">keySelector</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ConfigurableJWTProcessor</span><span class="o">&lt;</span><span class="n">SecurityContext</span><span class="o">&gt;</span> <span class="n">jwtProcessor</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">DefaultJWTProcessor</span><span class="o">();</span>
    <span class="n">jwtProcessor</span><span class="o">.</span><span class="na">setJWTClaimSetJWSKeySelector</span><span class="o">(</span><span class="n">keySelector</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">jwtProcessor</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you are already seeing, the trade-off for moving tenant-awareness down to this level is more configuration. We have just a bit more. Next, we still want to make sure you are validating the issuer. But, since the issuer may be different per JWT, then youâ€™ll need a tenant-aware validator, too:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TenantJwtIssuerValidator</span> <span class="kd">implements</span> <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">JwtIssuerValidator</span><span class="o">&gt;</span> <span class="n">validators</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">TenantJwtIssuerValidator</span><span class="o">(</span><span class="n">TenantRepository</span> <span class="n">tenants</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenants</span> <span class="o">=</span> <span class="n">tenants</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">OAuth2TokenValidatorResult</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Jwt</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">validators</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">toTenant</span><span class="o">(</span><span class="n">token</span><span class="o">),</span> <span class="k">this</span><span class="o">::</span><span class="n">fromTenant</span><span class="o">)</span>
                <span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">toTenant</span><span class="o">(</span><span class="n">Jwt</span> <span class="n">jwt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="na">getIssuer</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">JwtIssuerValidator</span> <span class="nf">fromTenant</span><span class="o">(</span><span class="n">String</span> <span class="n">tenant</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tenants</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">tenant</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;issuer&#34;</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">JwtIssuerValidator</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;unknown tenant&#34;</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now that we have a tenant-aware processor and a tenant-aware validator, we can proceed with creating our <code>JwtDecoder</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">JwtDecoder</span> <span class="nf">jwtDecoder</span><span class="o">(</span><span class="n">JWTProcessor</span> <span class="n">jwtProcessor</span><span class="o">,</span> <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="n">jwtValidator</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">NimbusJwtDecoder</span> <span class="n">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NimbusJwtDecoder</span><span class="o">(</span><span class="n">processor</span><span class="o">);</span>
    <span class="n">OAuth2TokenValidator</span><span class="o">&lt;</span><span class="n">Jwt</span><span class="o">&gt;</span> <span class="n">validator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DelegatingOAuth2TokenValidator</span><span class="o">&lt;&gt;</span>
            <span class="o">(</span><span class="n">JwtValidators</span><span class="o">.</span><span class="na">createDefault</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">jwtValidator</span><span class="o">);</span>
    <span class="n">decoder</span><span class="o">.</span><span class="na">setJwtValidator</span><span class="o">(</span><span class="n">validator</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">decoder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Weâ€™ve finished talking about resolving the tenant. If youâ€™ve chosen to resolve the tenant by request material, then youâ€™ll need to make sure you address your downstream resource servers in the same way. For example, if you are resolving it by subdomain, youâ€™ll need to address the downstream resource server using the same subdomain. However, if you resolve it by a claim in the bearer token, read on to learn about <a href="#oauth2resourceserver-bearertoken-resolver" title="12.3.21Â Bearer Token Resolution">Spring Securityâ€™s support for bearer token propagation</a>.</p>
<h2 id="21bearer-token-resolution"><a href="#21bearer-token-resolution" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:21bearer-token-resolution" class="headings">21Â Bearer Token Resolution</a></h2>
<p>By default, Resource Server looks for a bearer token in the <code>Authorization</code> header. This, however, can be customized in a couple of ways.</p>
<h3 id="reading-the-bearer-token-from-a-custom-header"><a href="#reading-the-bearer-token-from-a-custom-header" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:reading-the-bearer-token-from-a-custom-header" class="headings">Reading the Bearer Token from a Custom Header</a></h3>
<p>For example, you may have a need to read the bearer token from a custom header. To achieve this, you can wire a <code>HeaderBearerTokenResolver</code> instance into the DSL, as you can see in the following example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">http</span>
    <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
        <span class="o">.</span><span class="na">bearerTokenResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">HeaderBearerTokenResolver</span><span class="o">(</span><span class="s">&#34;x-goog-iap-jwt-assertion&#34;</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="reading-the-bearer-token-from-a-form-parameter"><a href="#reading-the-bearer-token-from-a-form-parameter" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:reading-the-bearer-token-from-a-form-parameter" class="headings">Reading the Bearer Token from a Form Parameter</a></h3>
<p>Or, you may wish to read the token from a form parameter, which you can do by configuring the <code>DefaultBearerTokenResolver</code>, as you can see below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">DefaultBearerTokenResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultBearerTokenResolver</span><span class="o">();</span>
<span class="n">resolver</span><span class="o">.</span><span class="na">setAllowFormEncodedBodyParameter</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">http</span>
    <span class="o">.</span><span class="na">oauth2ResourceServer</span><span class="o">()</span>
        <span class="o">.</span><span class="na">bearerTokenResolver</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="22bearer-token-propagation"><a href="#22bearer-token-propagation" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:22bearer-token-propagation" class="headings">22Â Bearer Token Propagation</a></h2>
<p>Now that youâ€™re in possession of a bearer token, it might be handy to pass that to downstream services. This is quite simple with <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/server/resource/web/reactive/function/client/ServletBearerExchangeFilterFunction.html" target="_blank" rel="noopener"><code>ServletBearerExchangeFilterFunction</code></a>, which you can see in the following example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">WebClient</span> <span class="nf">rest</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="k">new</span> <span class="n">ServletBearerExchangeFilterFunction</span><span class="o">())</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When the above <code>WebClient</code> is used to perform requests, Spring Security will look up the current <code>Authentication</code> and extract any <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/core/AbstractOAuth2Token.html" target="_blank" rel="noopener"><code>AbstractOAuth2Token</code></a> credential. Then, it will propagate that token in the <code>Authorization</code> header. For example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">this</span><span class="o">.</span><span class="na">rest</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;https://other-service.example.com/endpoint&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
        <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">block</span><span class="o">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Will invoke the <a href="https://other-service.example.com/endpoint" target="_blank" rel="noopener"><code>https://other-service.example.com/endpoint</code></a>, adding the bearer token <code>Authorization</code> header for you. In places where you need to override this behavior, itâ€™s a simple matter of supplying the header yourself, like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">this</span><span class="o">.</span><span class="na">rest</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;https://other-service.example.com/endpoint&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setBearerAuth</span><span class="o">(</span><span class="n">overridingToken</span><span class="o">))</span>
        <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
        <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">block</span><span class="o">()</span>
</code></pre></td></tr></table>
</div>
</div><p>In this case, the filter will fall back and simply forward the request onto the rest of the web filter chain.</p>
<blockquote>
<p>Unlike the <a href="https://docs.spring.io/spring-security/site/docs/current-SNAPSHOT/api/org/springframework/security/oauth2/client/web/reactive/function/client/ServletOAuth2AuthorizedClientExchangeFilterFunction.html" target="_blank" rel="noopener">OAuth 2.0 Client filter function</a>, this filter function makes no attempt to renew the token, should it be expired. To obtain this level of support, please use the OAuth 2.0 Client filter.</p>
</blockquote>
<h3 id="resttemplate-support"><a href="#resttemplate-support" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:resttemplate-support" class="headings"><code>RestTemplate</code> support</a></h3>
<p>There is no dedicated support for <code>RestTemplate</code> at the moment, but you can achieve propagation quite simply with your own interceptor:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="n">RestTemplate</span> <span class="nf">rest</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">RestTemplate</span> <span class="n">rest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
    <span class="n">rest</span><span class="o">.</span><span class="na">getInterceptors</span><span class="o">().</span><span class="na">add</span><span class="o">((</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">,</span> <span class="n">execution</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">execution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">AbstractOAuth2Token</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">execution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">AbstractOAuth2Token</span> <span class="n">token</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractOAuth2Token</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">();</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">setBearerAuth</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">getTokenValue</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">execution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
    <span class="o">});</span>
    <span class="k">return</span> <span class="n">rest</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></div>

        </article>

        

        
    
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">ä½œè€…</span>ï¼š<a href="https://wss.cool/" target="_blank" rel="noopener">ç‹ä¹¦ç¡•</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">é“¾æ¥</span>ï¼š<a href="/spring-security-jwt.html" target="_blank" rel="noopener">https://wss.cool/spring-security-jwt.html</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">è®¸å¯</span>ï¼š<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></li>
            
        </ul>
    



        
    <div class="updated-badge-container"><div title="Updated @ 2021-11-12 18:13:27 UTC" style="cursor:help;display:inline-block">

<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2021-11-12</text><text x="915" y="140" textLength="650" transform="scale(.1)">2021-11-12</text></g></svg></div></div>


        

        
    
    

<div class="post-share">

        

        <div class="share-items">

            
                
                <div class="share-item twitter">
                    
                    <a href="https://twitter.com/share?url=https://wss.cool/spring-security-jwt.html&amp;text=Spring%20Security%20JWT&amp;via=shuo666" title="åˆ†äº«åˆ°ã€ŒTwitterã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </div>
            

            
                
                <div class="share-item facebook">
                    
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https://wss.cool/spring-security-jwt.html" title="åˆ†äº«åˆ°ã€ŒFacebookã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a>
                </div>
            

            
                
                <div class="share-item linkedin">
                    
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://wss.cool/spring-security-jwt.html&amp;title=Spring%20Security%20JWT&amp;summary=Spring%20Security%20Architecture%20Spring%20Security%20%e6%9e%b6%e6%9e%84%ef%bc%8c%e5%85%a5%e9%97%a8%e4%bb%8b%e7%bb%8d%ef%bc%9a%e7%bd%91%e5%9d%80%20Authentication%20and%20Access%20Control%20%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%ae%89%e5%85%a8%e6%80%a7%e5%bd%92%e7%bb%93%e4%b8%ba%e6%88%96%e5%a4%9a%e6%88%96%e5%b0%91%e7%9a%84%e4%b8%a4%e4%b8%aa%e7%8b%ac%e7%ab%8b%e9%97%ae%e9%a2%98%ef%bc%9a%e8%ba%ab%e2%80%a6%e2%80%a6&amp;source=WSS.COOL" title="åˆ†äº«åˆ°ã€ŒLinkedInã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </div>
            

            
                
                <div class="share-item telegram">
                    
                    <a href="https://t.me/share/url?url=https://wss.cool/spring-security-jwt.html&amp;text=Spring%20Security%20JWT" title="åˆ†äº«åˆ°ã€ŒTelegramã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a>
                </div>
            

            
                
                <div class="share-item weibo">
                    
                    <a href="https://service.weibo.com/share/share.php?&amp;url=https://wss.cool/spring-security-jwt.html&amp;title=Spring%20Security%20JWT&amp;pic=https://wss.cool/images/1.png&amp;searchPic=false" title="åˆ†äº«åˆ°ã€Œæ–°æµªå¾®åšã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon weibo-icon"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></a>
                </div>
            

            
                
                <div class="share-item douban">
                    
                    <a href="https://www.douban.com/share/service?href=https://wss.cool/spring-security-jwt.html&amp;name=Spring%20Security%20JWT&amp;text=Spring%20Security%20Architecture%20Spring%20Security%20%e6%9e%b6%e6%9e%84%ef%bc%8c%e5%85%a5%e9%97%a8%e4%bb%8b%e7%bb%8d%ef%bc%9a%e7%bd%91%e5%9d%80%20Authentication%20and%20Access%20Control%20%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%ae%89%e5%85%a8%e6%80%a7%e5%bd%92%e7%bb%93%e4%b8%ba%e6%88%96%e5%a4%9a%e6%88%96%e5%b0%91%e7%9a%84%e4%b8%a4%e4%b8%aa%e7%8b%ac%e7%ab%8b%e9%97%ae%e9%a2%98%ef%bc%9a%e8%ba%ab%e2%80%a6%e2%80%a6" title="åˆ†äº«åˆ°ã€Œè±†ç“£ã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon douban-icon"><path d="M.643.92v2.412h22.714V.92H.643zm1.974 4.926v9.42h18.764v-9.42H2.617zm2.72 2.408H18.69v4.605H5.338V8.254zm1.657 7.412l-2.512.938c1.037 1.461 1.87 2.825 2.512 4.091H0v2.385h24v-2.385h-6.678c.818-1.176 1.589-2.543 2.303-4.091l-2.73-.938a29.952 29.952 0 01-2.479 5.03h-4.75c-.786-1.962-1.677-3.641-2.672-5.03Z"/></svg></a>
                </div>
            

            
                
                <div class="share-item qq">
                    
                    <a href="https://connect.qq.com/widget/shareqq/index.html?url=https://wss.cool/spring-security-jwt.html&amp;title=Spring%20Security%20JWT&amp;summary=Spring%20Security%20Architecture%20Spring%20Security%20%e6%9e%b6%e6%9e%84%ef%bc%8c%e5%85%a5%e9%97%a8%e4%bb%8b%e7%bb%8d%ef%bc%9a%e7%bd%91%e5%9d%80%20Authentication%20and%20Access%20Control%20%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%ae%89%e5%85%a8%e6%80%a7%e5%bd%92%e7%bb%93%e4%b8%ba%e6%88%96%e5%a4%9a%e6%88%96%e5%b0%91%e7%9a%84%e4%b8%a4%e4%b8%aa%e7%8b%ac%e7%ab%8b%e9%97%ae%e9%a2%98%ef%bc%9a%e8%ba%ab%e2%80%a6%e2%80%a6&amp;pics=https://wss.cool/images/1.png&amp;site=WSS.COOL" title="åˆ†äº«åˆ°ã€ŒQQã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741 0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792 0 0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a>
                </div>
            

            
                
                <div class="share-item qzone">
                    
                    <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://wss.cool/spring-security-jwt.html&amp;title=Spring%20Security%20JWT&amp;summary=Spring%20Security%20Architecture%20Spring%20Security%20%e6%9e%b6%e6%9e%84%ef%bc%8c%e5%85%a5%e9%97%a8%e4%bb%8b%e7%bb%8d%ef%bc%9a%e7%bd%91%e5%9d%80%20Authentication%20and%20Access%20Control%20%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e5%ae%89%e5%85%a8%e6%80%a7%e5%bd%92%e7%bb%93%e4%b8%ba%e6%88%96%e5%a4%9a%e6%88%96%e5%b0%91%e7%9a%84%e4%b8%a4%e4%b8%aa%e7%8b%ac%e7%ab%8b%e9%97%ae%e9%a2%98%ef%bc%9a%e8%ba%ab%e2%80%a6%e2%80%a6&amp;pics=https://wss.cool/images/1.png&amp;site=WSS.COOL" title="åˆ†äº«åˆ°ã€ŒQQ ç©ºé—´ã€" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon qzone-icon"><path d="M23.985 9.202c-.032-.099-.127-.223-.334-.258-.207-.036-7.351-1.406-7.351-1.406s-.105-.022-.198-.07c-.092-.047-.127-.167-.127-.167S12.447.956 12.349.77C12.25.583 12.104.532 12 .532c-.104 0-.251.051-.349.238-.098.186-3.626 6.531-3.626 6.531s-.035.12-.128.167c-.092.047-.197.07-.197.07S.556 8.908.348 8.943c-.208.036-.302.16-.333.258a.477.477 0 0 0 .125.449l5.362 5.49s.072.08.119.172c.016.104.005.21.005.21s-1.189 7.242-1.22 7.45.075.369.159.43c.083.062.233.106.421.013.189-.093 6.812-3.261 6.812-3.261s.098-.044.201-.061c.103-.017.201.061.201.061s6.623 3.168 6.812 3.261c.188.094.338.049.421-.013a.463.463 0 0 0 .159-.43c-.021-.14-.93-5.677-.93-5.677.876-.54 1.425-1.039 1.849-1.747-2.594.969-6.006 1.717-9.415 1.866-.915.041-2.41.097-3.473-.015-.678-.071-1.17-.144-1.243-.438-.053-.215.054-.46.545-.831a2640.5 2640.5 0 0 1 2.861-2.155c1.285-.968 3.559-2.47 3.559-2.731 0-.285-2.144-.781-4.037-.781-1.945 0-2.275.132-2.811.168-.488.034-.769.005-.804-.138-.06-.248.183-.389.588-.568.709-.314 1.86-.594 1.984-.626.194-.052 3.082-.805 5.618-.535 1.318.14 3.244.668 3.244 1.276 0 .342-1.721 1.494-3.225 2.597-1.149.843-2.217 1.561-2.217 1.688 0 .342 3.533 1.241 6.689 1.01l.003-.022c.048-.092.119-.172.119-.172l5.362-5.49a.477.477 0 0 0 .127-.449z"/></svg></a>
                </div>
            

            
                
                <div class="share-item qrcode">
                    <div class="qrcode-container" title="é€šè¿‡ã€ŒäºŒç»´ç ã€"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id="qrcode-img"></div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    var typeNumber = 0;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https:\/\/wss.cool\/spring-security-jwt.html');
    qr.make();
    document.getElementById('qrcode-img').innerHTML = qr.createImgTag();
</script>

                </div>
            

        </div>

    </div>




        
    
    
        <div class="related-posts">
            <h2 class="related-title">ç›¸å…³æ–‡ç« ï¼š<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg></h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/learn-go-3.html" class="related-link">GoåŸºç¡€ä¸‰ï¼šæ–¹æ³•å’Œæ¥å£</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/learn-go-2.html" class="related-link">GoåŸºç¡€äºŒï¼šæµç¨‹æ§åˆ¶è¯­å¥</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/learn-go-1.html" class="related-link">GoåŸºç¡€ä¸€ï¼šåŒ…ã€å˜é‡å’Œå‡½æ•°</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/%E8%AE%BE%E7%BD%AEjar%E5%8C%85%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98.html" class="related-link">è®¾ç½®jaråŒ…ä½¿ç”¨å†…å­˜</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/mysql%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5.html" class="related-link">Mysqlå¢åˆ æ”¹æŸ¥</a>
                    </li>
                
            </ul>
        </div>
    


        
    
    


        

        

        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/java%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7.html" rel="prev">< Javaåç«¯å¼€å‘å¸¸ç”¨å·¥å…·</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/spring%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5.html" rel="next">Springæ¨èä½¿ç”¨æ„é€ å™¨æ³¨å…¥ ></a>
                </li>
            
        </ul>
    


        


    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>

            
    <footer id="footer" class="footer">
        <div class="footer-inner"><div class="site-info">Â©&nbsp;1990â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;ç‹ä¹¦ç¡•</div><div class="powered-by">Powered by <a href="https://github.com/gohugoio/hugo" target="_blank" rel="noopener">Hugo</a> | Theme is <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a></div><div class="site-copyright"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></div><div class="custom-footer"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener">èœ€ICPå¤‡20009942</a></div>

            <a target="_blank" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=VSImJnsiOic_FTM6LTg0PDl7Njo4" style="text-decoration:none;"><img src="https://rescdn.qqmail.com/zh_CN/htmledition/images/function/qm_open/ico_mailme_01.png"/></a>
        </div>
    </footer>


        </div>
        <script src="/js/meme.min.d2300d8a5efd5b4bf2aaa4797b7b38684ee3cc6a0741bd3d6190f80633d8ea65.js" integrity="sha256-0jANil79W0vyqqR5e3s4aE7jzGoHQb09YZD4BjPY6mU="></script>


    <script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>

<script>
    var scroll = new SmoothScroll('a[href*="#"]', {
        speedAsDuration: true,
        header: '[data-scroll-header]'
    });
</script>












    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@3.0.0/instantpage.min.js" type="module" defer></script>










    </body>
</html>
